{% extends "creel_portal_base.html" %}

{% load static %}

{% block extrahead %}

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />

<script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />


<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script src="{% static 'Leaflet.MakiMarkers.js' %}"></script>

{% endblock extrahead %}


{% block content %}


<div class="container">
    <h3>{{space.creel.prj_nm|title}} ({{space.creel.prj_cd}})</h3>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title"> {{ space.space_des|title}} ({{space.space}})</h3>
        </div>
        <div class="panel-body">



            <form method="post" action=".">
                {% csrf_token %}
                {% if form.errors %}
                <div class="alert alert-danger">
                    Please fix the errors in the form below.
                    {% for error in form.non_field_errors %}
                    <p class="error">{{ error }}</p>
                    {% endfor %}
                    {% for error in form.errors %}
                    <p class="error">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                {% if msg %}
                <div class="alert alert-danger">
                    {{ msg }}
                </div>
                {% endif %}

                <div id="location_row" class="row" >
                    <div class="col-md-4" >

                        <div class="form-group {% if form.general_location.errors %}has-error{% endif %}">
                            {{ form.general_location.label_tag }}
                            {{ form.general_location }}
                            {% if form.general_location.errors %}
                            {% for error in form.general_location.errors %}
                            <div class="has-error help-block text-danger">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div class="form-group {% if form.specific_location.errors %}has-error{% endif %}">
                            {{ form.specific_location.label_tag }}
                            {{ form.specific_location }}
                            {% if form.specific_location.errors %}
                            {% for error in form.specific_location.errors %}
                            <div class="has-error help-block text-danger">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="row" >
                            <div class="col-md-4" >
                                <h4>Coordinates</h4>
                            </div>
                        </div>

                        <div class="panel panel-default"> <!-- out tabpanel -->
                            <div class="panel-body">      <!-- out tab panel body-->
                                <div>
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li role="presentation" class="active"><a href="#decimal_degrees" aria-controls="decimal_degrees" role="tab" data-toggle="tab">Dec. Deg.</a></li>
                                        <li role="presentation"><a href="#ddm" aria-controls="ddm" role="tab" data-toggle="tab">Dec. Min.</a></li>
                                        <li role="presentation"><a href="#dms" aria-controls="dms" role="tab" data-toggle="tab">Deg-Min-Secs</a></li>
                                    </ul>

                                    <!-- Tab panes -->
                                    <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="decimal_degrees">

                                            <br />
                                            <p><strong>Latitude:</strong></p>
                                            <div class="form-group">
                                                <label class="sr-only" for="id_ddlat">Latitude:</label>
                                                <input type="text" class="form-control" id="id_ddlat" name="ddlat" type="text" placeholder="Decimal Degrees" value="{{ form.ddlat.value|default_if_none:''}}">
                                                <div id="ddlat_deg_error" class="alert alert-danger" role="alert">
                                                    Degrees must be a number between -90 and 90!
                                                </div>
                                                {% if form.ddlat.errors %}
                                                {% for error in form.ddlat.errors %}
                                                <div class="has-error help-block text-danger">{{ error }}</div>
                                                {% endfor %}
                                                {% endif %}
                                            </div>

                                            <p><strong>Longitude:</strong></p>
                                            <div class="form-group">
                                                <label class="sr-only" for="id_ddlon">Longitude:</label>
                                                <input type="text" class="form-control" id="id_ddlon" name="ddlon" type="text" placeholder="Decimal Degrees" value="{{ form.ddlon.value|default_if_none:'' }}">
                                                <div id="ddlon_deg_error" class="alert alert-danger" role="alert">
                                                    Degrees must be a number between -180 and 180!
                                                </div>
                                                {% if form.ddlon.errors %}
                                                {% for error in form.ddlon.errors %}
                                                <div class="has-error help-block text-danger">{{ error }}</div>
                                                {% endfor %}
                                                {% endif %}


                                            </div>


                                        </div> <!-- tabpanel -->
                                        <div role="tabpanel" class="tab-pane" id="ddm">
                                            <br />
                                            <p><strong>Latitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-6" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="ddm_lat_deg">Degrees:</label>
                                                        <input type="text" name="ddm_lat" class="form-control" id="ddm_lat_deg" placeholder="Degrees">
                                                        <div id="ddm_lat_deg_error" class="alert alert-danger" role="alert">
                                                            Degrees must be an integer!
                                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-6" >

                                                    <div class="form-group">
                                                        <label  class="sr-only" for="ddm_lat_min">Decimal Minutes:</label>
                                                        <input type="text" name="ddm_lat" class="form-control" id="ddm_lat_min" placeholder="Decimal Minutes">
                                                        <div id="ddm_lat_min_error" class="alert alert-danger" role="alert">
                                                            Minutes must be between 0 and 60!
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>

                                            <p><strong>Longitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-6" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="ddm_lon_deg">Degrees:</label>
                                                        <input type="text" name="ddm_lon" class="form-control" id="ddm_lon_deg" placeholder="Degrees">
                                                        <div id="ddm_lon_deg_error" class="alert alert-danger" role="alert">
                                                            Degrees must be an integer!
                                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-6" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="ddm_lon_min">Decimal Minutes:</label>
                                                        <input type="text" name="ddm_lon" class="form-control" id="ddm_lon_min" placeholder="Decimal Minutes">
                                                        <div id="ddm_lon_min_error" class="alert alert-danger" role="alert">
                                                            Minutes must be between 0 and 60!
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>


                                        </div>  <!-- tabpanel -->

                                        <div role="tabpanel" class="tab-pane" id="dms">
                                            <br />

                                            <p><strong>Latitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="dms_lat_deg">Degrees:</label>
                                                        <input type="text" name="dms_lat" class="form-control" id="dms_lat_deg" placeholder="Degrees">
                                                        <div id="dms_lat_deg_error" class="alert alert-danger" role="alert">
                                                            Degrees must be an integer between -90 and 90!
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lat_min">Minutes:</label>
                                                        <input type="text"  name="dms_lat"  class="form-control" id="dms_lat_min" placeholder="Minutes">
                                                        <div id="dms_lat_min_error" class="alert alert-danger" role="alert">
                                                            Minutes must be an integer between 0 and 59!
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lat_sec">Seconds:</label>
                                                        <input type="text"  name="dms_lat" class="form-control" id="dms_lat_sec" placeholder="Seconds">
                                                        <div id="dms_lat_sec_error" class="alert alert-danger" role="alert">
                                                            seconds must be between 0 and 60!
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <p><strong>Longitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="dms_lon_deg">Degrees:</label>
                                                        <input type="text"  name="dms_lon" class="form-control" id="dms_lon_deg" placeholder="Degrees">
                                                        <div id="dms_lon_deg_error" class="alert alert-danger" role="alert">
                                                            Degrees must be an integer between -180 and 180!
                                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lon_min">Minutes:</label>
                                                        <input type="text" name="dms_lon" class="form-control" id="dms_lon_min" placeholder="Minutes">
                                                        <div id="dms_lon_min_error" class="alert alert-danger" role="alert">
                                                            Minutes must be an integer between 0 and 59!
                                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lon_sec">Seconds:</label>
                                                        <input type="text" name="dms_lon" class="form-control" id="dms_lon_sec" placeholder="Seconds">
                                                        <div id="dms_lon_sec_error" class="alert alert-danger" role="alert">
                                                            Seconds must be between 0 and 60!
                                                        </div>

                                                    </div>
                                                </div>

                                            </div>


                                        </div>  <!-- tabpanel -->

                                    </div>  <!-- tabcontent -->
                                </div>  <!-- outer tab panel body -->
                            </div> <!-- outer tab panel -->
                        </div>

                    </div> <!-- location widgets -->
                    <div class="col-md-8" >
                        <p>1) Or place the marker in the center of the space </p>
                        <div id="main_map" style="width: 650px; height: 650px;"></div>
                        <p class="pull-right"  id="latlon_text"></p>
                    </div> <!-- map column-->
                </div>
                <hr />
                <input class="btn btn-primary pull-right" type="submit" value="Submit">
            </form>
        </div>
    </div>
</div>



<script type="text/javascript">

 $(document).ready(function(){


     $('#myTabs a').click(function (e) {
         e.preventDefault()
         $(this).tab('show')
     });



     //make sure all of the error messages are hidden when we load the form:

     clear_lat_long_errors();

     var my_map;
     //var popup_map;
     var my_markers = new Array();
     //var popup_markers = new Array();

     // marker arrays - when we click on the map, create a new marker with the coordinates of the click
     // delete any existing markers in the array
     // add the new marker to the array.


     // we will use the same 'custom' marker everywhere (the blue
     // default is hard to see over blue water).
     var icon = L.MakiMarkers.icon({icon: "marker", color: "#b0b", size: "m"});


     initmap();
     refresh_map();

     function clear_lat_long_errors(){
         $( "#ddlat_deg_error" ).hide();
         $( "#ddlon_deg_error" ).hide();

         $( "#dms_lat_deg_error" ).hide();
         $( "#dms_lat_min_error" ).hide();
         $( "#dms_lat_sec_error" ).hide();

         $( "#dms_lon_deg_error" ).hide();
         $( "#dms_lon_min_error" ).hide();
         $( "#dms_lon_sec_error" ).hide();

         $( "#ddm_lat_deg_error" ).hide();
         $( "#ddm_lat_min_error" ).hide();

         $( "#ddm_lon_deg_error" ).hide();
         $( "#ddm_lon_min_error" ).hide();
     }


     function refresh_map(){
         // anytime one of the text box controls change (with a valid
         // value) we need to update the marker on our map

         var ddlat = parseFloat($('input[id="id_ddlat"]').val());
         var ddlon = parseFloat($('input[id="id_ddlon"]').val());


         if(isNaN(ddlat)===false && isNaN(ddlon)===false){

             $('input:radio[name="latlon_flag"]').val(["1"]); // 1 == 'Reported'

             var pt = L.latLng(ddlat, ddlon);
             clear_lat_long_errors();

             //if the length of our marker array is more than , we have a
             if (my_markers.length && typeof my_markers[0] !== 'undefined'){
                 my_map.removeLayer(my_markers[0]);
                 delete my_markers[0];
             }

             var marker = L.marker(pt,{icon:icon});
             my_map.addLayer(marker);
             my_markers[0] = marker;

             my_map.panTo(marker.getLatLng());
         }
     }

     function initmap(){
         // we will initialize the map over lake huron - this could be customized at some point in the future.


         // if edit - zoom to existing point

         // else set zoom and coords to lake

         var ddlat = 45;
         var ddlon = -82;
         var zoom = 7;

         my_map = new L.map('main_map').setView([ddlat, ddlon], zoom);

         L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWNvdHRyaWxsIiwiYSI6ImNpazVmb3Q2eDAwMWZpZm0yZTQ1cjF3NTkifQ.Pb1wCYs0lKgjnTGz43DjVQ'
                   , {
                       maxZoom: 18,
                       attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                                    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                                    'Imagery  <a href="http://mapbox.com">Mapbox</a>',
                       id: 'mapbox.streets'
                   }).addTo(my_map);

     };


     function update_controls(ddlat, ddlon){
         // when we get a new lat-long - either from a click on our main map, or a submission from our popup-map,
         // we need to update the main map and then update each of the lat-long controls.

         // Every time when user click on map we want to update
         // the marker with the new position where the user clicked
         var pt = L.latLng(ddlat, ddlon);

         clear_lat_long_errors();

         $('input:radio[name="latlon_flag"]').val(["1"]); // 1 == 'Reported'

         //if the length of our marker array is more than 0 or the first element is not
         //undefined, we have a point to remove and delete
         if (my_markers.length && typeof my_markers[0] !== 'undefined'){
             my_map.removeLayer(my_markers[0]);
             delete my_markers[0];
         }

         var marker = L.marker(pt,{icon:icon});
         my_map.addLayer(marker);
         my_markers[0] = marker;

         my_map.panTo(pt);

         //update the other input values with the coordinates from the map marker:
         var lat_idegrees = Math.floor(ddlat);
         var lat_dminutes = (ddlat - lat_idegrees) * 60;
         var lat_iminutes = Math.floor(lat_dminutes);
         var lat_seconds = (lat_dminutes - lat_iminutes) * 60;

         $('input[id="id_ddlat"]').val(ddlat);

         $('input[id="ddm_lat_deg"]').val(lat_idegrees);
         $('input[id="ddm_lat_min"]').val(lat_dminutes);

         $('input[id="dms_lat_deg"]').val(lat_idegrees);
         $('input[id="dms_lat_min"]').val(lat_iminutes);
         $('input[id="dms_lat_sec"]').val(lat_seconds);

         ddlon = Math.abs(ddlon);
         var lon_idegrees = Math.floor(ddlon);
         var lon_dminutes = (ddlon - lon_idegrees) * 60;
         var lon_iminutes = Math.floor(lon_dminutes);
         var lon_seconds = (lon_dminutes - lon_iminutes) * 60;

         $('input[id="id_ddlon"]').val(ddlon * -1);

         $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);
         $('input[id="ddm_lon_min"]').val(lon_dminutes);

         $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);
         $('input[id="dms_lon_min"]').val(lon_iminutes);
         $('input[id="dms_lon_sec"]').val(lon_seconds);


         // the coordinates under the map:
         $("#latlon_text").html('<em>' +  ddlat.toFixed(4) + '&deg;N ' + ddlon.toFixed(4) + '&deg;W</em>');

     }


     // from http://ipasic.com/article/let-user-add-point-map-geodjango-leaflet/
     function onMapClick(e) {
         // capture the click events on our map an update the other controls accordingly
         var ddlat = e.latlng.lat;
         var ddlon = e.latlng.lng;

         update_controls(ddlat, ddlon);
     }

     // call the onMapClick function when user click on map
     my_map.on('click', onMapClick);

//     function init_popup_map(){
//
//         // initialize the popup map with the current settings of the main map:
//         //popup_map = new L.map('popup_map').setView(my_map.getCenter(), my_map.getZoom());
//         if (typeof popup_map == 'undefined'){
//             popup_map = new L.map('popup_map')
//         }
//         popup_map.setView(my_map.getCenter(), my_map.getZoom());
//
//         L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWNvdHRyaWxsIiwiYSI6ImNpazVmb3Q2eDAwMWZpZm0yZTQ1cjF3NTkifQ.Pb1wCYs0lKgjnTGz43DjVQ', {
//             maxZoom: 18,
//             attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
//                          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
//                          'Imagery  <a href="http://mapbox.com">Mapbox</a>',
//             id: 'mapbox.streets'
//         }).addTo(popup_map);
//
//
//         if (my_markers.length && typeof my_markers[0] != 'undefined') {
//             var pt = my_markers[0].getLatLng();
//
//             //if the length of our marker array is more than , we have a
//             if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
//                 popup_map.removeLayer(popup_markers[0]);
//                 delete popup_markers[0];
//             }
//
//             var marker = L.marker(pt,{icon:icon});
//             popup_map.addLayer(marker);
//             popup_markers[0] = marker;
//             popup_map.panTo(pt);
//         }
//
//
//     };

//     function onPopupMapClick(e) {
//         // capture the location of any clicks on our popup map and put the point there
//         var ddlat = e.latlng.lat;
//         var ddlon = e.latlng.lng;
//
//         var pt = L.latLng(ddlat, ddlon);
//
//         if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
//             popup_map.removeLayer(popup_markers[0]);
//             delete popup_markers[0];
//         }
//
//         var marker = L.marker(pt,{icon:icon});
//         popup_map.addLayer(marker);
//         popup_markers[0] = marker;
//
//
//     };
//
//
//     // when we open the modal dialog, initialize a map and associated click events with our function.
//     $('#myModal').on('shown.bs.modal',function(){
//         init_popup_map();
//         popup_map.on('click', onPopupMapClick);
//     });
//
//     $(function () {
//         // if the submit button the popup form is clicked, get the
//         //coordinates from the marker (if it exists) and
//         // update all of the lat-lon controls
//         $('body').on('click', '.popup-submit', function (e) {
//
//             if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
//                 var pt = popup_markers[0].getLatLng();
//                 update_controls(pt.lat, pt.lng);
//             }
//
//             //finally hide the popup map:
//             $('#myModal').modal('hide');
//
//         });
//     });
//
//
//     $('input[id="id_ddlat"]').change (function () {
//
//         var ddlat = parseFloat($('input[id="id_ddlat"]').val());
//
//         var valid = check_ddlat(ddlat);
//         if (valid){
//             var lat_idegrees = Math.floor(ddlat);
//             var lat_dminutes = (ddlat - lat_idegrees) * 60;
//             var lat_iminutes = Math.floor(lat_dminutes);
//             var lat_seconds = (lat_dminutes - lat_iminutes) * 60;
//
//             $('input[id="ddm_lat_deg"]').val(lat_idegrees);
//             $('input[id="ddm_lat_min"]').val(lat_dminutes);
//
//             $('input[id="dms_lat_deg"]').val(lat_idegrees);
//             $('input[id="dms_lat_min"]').val(lat_iminutes);
//             $('input[id="dms_lat_sec"]').val(lat_seconds);
//
//             refresh_map();
//         }
//
//
//     });
//

     $('input[id="id_ddlon"]').change (function () {

         var ddlon = parseFloat($('input[id="id_ddlon"]').val());

         var valid = check_ddlon(ddlon);

         if (valid){
             ddlon = Math.abs(ddlon);
             var lon_idegrees = Math.floor(ddlon);
             var lon_dminutes = (ddlon - lon_idegrees) * 60;
             var lon_iminutes = Math.floor(lon_dminutes);
             var lon_seconds = (lon_dminutes - lon_iminutes) * 60;

             $('input[id="id_ddlon"]').val(ddlon * -1);

             $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="ddm_lon_min"]').val(lon_dminutes);

             $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="dms_lon_min"]').val(lon_iminutes);
             $('input[id="dms_lon_sec"]').val(lon_seconds);

             refresh_map();
         }
     });



     function check_dms_lat( lat_degrees, lat_minutes, lat_seconds){

         // if both ddm_lat_deg and ddm_lon_min are populated, we need to check their values
         // if only one is populated, do nothing (for now)
         // if their values are ok, update the other, related controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90

         // degrees must be an integer between 90 and 90
         if(isNaN(lat_degrees) || parseInt(lat_degrees)!==lat_degrees ||
            lat_degrees <-90 ||
            lat_degrees > 90){
             $( "#dms_lat_deg_error" ).show();
             $( "#dms_lat_deg" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lat_deg_error" ).hide();
             $( "#dms_lat_deg" ).removeClass("has-error");
         }

         // minutes must be an integer between 0 and 59.999
         if(isNaN(lat_minutes) || parseInt(lat_minutes)!==lat_minutes ||
            lat_minutes < 0 || lat_minutes >=60){
             $( "#dms_lat_min_error" ).show();
             $( "#dms_lat_min" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lat_min_error" ).hide();
             $( "#dms_lat_min" ).removeClass("has-error");
         }


         if(isNaN(lat_seconds) || lat_seconds < 0 || lat_seconds >=60){
             $( "#dms_lat_sec_error" ).show();
             $( "#dms_lat_sec" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lat_sec_error" ).hide();
             $( "#dms_lat_sec" ).removeClass("has-error");
         }

         return true
     }



     function check_ddlat(lat_degrees){
         // check_ddlat
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90


         if(isNaN(lat_degrees) || lat_degrees< -90 || lat_degrees> 90){
             $( "#ddlat_deg_error" ).show();
             $( 'input[id="id_ddlat"]' ).addClass("has-error");
             return false
         } else {
             $( "#ddlat_deg_error" ).hide();
             $( 'input[id="id_ddlat"]' ).removeClass("has-error");
         }

         return true
     }


     function check_ddlon(lon_degrees){
         // check_ddlon
         // both degrees and minutes must be populoned
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90


         if(isNaN(lon_degrees) || lon_degrees < -180 || lon_degrees> 180){
             $( "#ddlon_deg_error" ).show();
             $( 'input[id="id_ddlon"]' ).addClass("has-error");
             return false
         } else {
             $( "#ddlon_deg_error" ).hide();
             $( 'input[id="id_ddlon"]' ).removeClass("has-error");
         }

         return true
     }



     function check_dms_lon( lon_degrees, lon_minutes, lon_seconds){

         // if both ddm_lon_deg and ddm_lon_min are populoned, we need to check their values
         // if only one is populoned, do nothing (for now)
         // if their values are ok, update the other, reloned controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populoned
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90

         // degrees must be an integer between 90 and 90
         if(isNaN(lon_degrees) || parseInt(lon_degrees)!==lon_degrees ||
            lon_degrees <-90 ||
            lon_degrees > 90){
             $( "#dms_lon_deg_error" ).show();
             $( "#dms_lon_deg" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lon_deg_error" ).hide();
             $( "#dms_lon_deg" ).removeClass("has-error");
         }

         // minutes must be an integer between 0 and 59.999
         if(isNaN(lon_minutes) || parseInt(lon_minutes)!==lon_minutes ||
            lon_minutes < 0 || lon_minutes >=60){
             $( "#dms_lon_min_error" ).show();
             $( "#dms_lon_min" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lon_min_error" ).hide();
             $( "#dms_lon_min" ).removeClass("has-error");
         }


         if(isNaN(lon_seconds) || lon_seconds < 0 || lon_seconds >=60){
             $( "#dms_lon_sec_error" ).show();
             $( "#dms_lon_sec" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lon_sec_error" ).hide();
             $( "#dms_lon_sec" ).removeClass("has-error");
         }

         return true
     }


     function check_ddm_lat( lat_idegrees, lat_dminutes){
         // check_ddm_lat

         // if both ddm_lat_deg and ddm_lon_min are populated, we need to check their values
         // if only one is populated, do nothing (for now)
         // if their values are ok, update the other, related controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90


         if(isNaN(lat_idegrees) || parseInt(lat_idegrees)!==lat_idegrees ||
            lat_idegrees< -90 ||
            lat_idegrees> 90){
             $( "#ddm_lat_deg_error" ).show();
             $( "#ddm_lat_deg" ).addClass("has-error");
             return false
         } else {
             $( "#ddm_lat_deg_error" ).hide();
             $( "#ddm_lat_deg" ).removeClass("has-error");
         }

         if(isNaN(lat_dminutes) || lat_dminutes < 0 || lat_dminutes >=60){
             $( "#ddm_lat_min_error" ).show();
             $( "#ddm_lat_min" ).addClass("has-error");
             return false
         } else {
             $( "#ddm_lat_min_error" ).hide();
             $( "#ddm_lat_min" ).removeClass("has-error");
         }

         return true
     }

     function check_ddm_lon( lon_idegrees, lon_dminutes){
         // check_ddm_lon

         // if both ddm_lon_deg and ddm_lon_min are populoned, we need to check their values
         // if only one is populoned, do nothing (for now)
         // if their values are ok, update the other, reloned controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populoned
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -180 and 180

         if(isNaN(lon_idegrees) || parseInt(lon_idegrees)!==lon_idegrees ||
            lon_idegrees < -180 ||
            lon_idegrees >=180){
             $( "#ddm_lon_deg_error" ).show();
             $( "#ddm_lon_deg" ).addClass("has-error");
             return false
         } else {
             $( "#ddm_lon_deg_error" ).hide();
             $( "#ddm_lon_deg" ).removeClass("has-error");
         }

         if(isNaN(lon_dminutes) || lon_dminutes < 0 || lon_dminutes >=60){
             $( "#ddm_lon_min_error" ).show();
             $( "#ddm_lon_min" ).addClass("has-error");
             return false
         } else {
             $( "#ddm_lon_min_error" ).hide();
             $( "#ddm_lon_min" ).removeClass("has-error");
         }

         return true
     }




     $('input[name="ddm_lat"]').change (function () {


         //if any of the latitude elements on the ddm page change, update the other formats.
         var lat_idegrees = parseFloat($('input[id="ddm_lat_deg"]').val());
         var lat_dminutes = parseFloat($('input[id="ddm_lat_min"]').val());

         var valid = check_ddm_lat(lat_idegrees, lat_dminutes);

         if(valid){

             // update the controls on the dd tab
             ddlat = lat_idegrees + lat_dminutes / 60;
             $('input[id="id_ddlat"]').val(ddlat);

             var lat_iminutes = Math.floor(lat_dminutes);
             var lat_seconds = (lat_dminutes - lat_iminutes) * 60;

             // update the controls on the dms tab
             $('input[id="dms_lat_deg"]').val(lat_idegrees);
             $('input[id="dms_lat_min"]').val(lat_iminutes);
             $('input[id="dms_lat_sec"]').val(lat_seconds);

             refresh_map();
         }
     });

     $('input[name="ddm_lon"]').change (function () {
         //if any of the longitude elements on the ddm page change, update the other formats.
         var lon_idegrees = parseFloat($('input[id="ddm_lon_deg"]').val());
         lon_idegrees = Math.abs(lon_idegrees);
         var lon_dminutes = parseFloat($('input[id="ddm_lon_min"]').val());

         var valid = check_ddm_lon(lon_idegrees, lon_dminutes);

         if(valid){

             $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);

             // calculate decimal degrees and update the dd tab
             var ddlon = (lon_idegrees + lon_dminutes / 60);
             $('input[id="id_ddlon"]').val(ddlon * -1);

             var lon_iminutes = Math.floor(lon_dminutes);
             var lon_seconds = (lon_dminutes - lon_iminutes) * 60;
             // update the controls on the dms tab
             $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="dms_lon_min"]').val(lon_iminutes);
             $('input[id="dms_lon_sec"]').val(lon_seconds);

             refresh_map();
         }

     });


     $('input[name="dms_lat"]').change (function () {
         //if any of the latitude elements on the dms page change, update the other formats.

         var lat_idegrees = parseFloat($('input[id="dms_lat_deg"]').val());
         var lat_iminutes = parseFloat($('input[id="dms_lat_min"]').val());
         var lat_seconds = parseFloat($('input[id="dms_lat_sec"]').val());

         var valid = check_dms_lat(lat_idegrees, lat_iminutes, lat_seconds);

         if (valid===true){

             // ddm tab
             var lat_dminutes = lat_iminutes + lat_seconds / 60;
             $('input[id="ddm_lat_deg"]').val(lat_idegrees);
             $('input[id="ddm_lat_min"]').val(lat_dminutes);

             // decimal degree tab
             var ddlat = lat_idegrees + lat_dminutes / 60;
             $('input[id="id_ddlat"]').val(ddlat);

             refresh_map();
         }

     });

     $('input[name="dms_lon"]').change (function () {
         //if any of the longitude elements on the dms page change, update the other formats.

         var lon_idegrees = parseFloat($('input[id="dms_lon_deg"]').val());
         var lon_iminutes = parseFloat($('input[id="dms_lon_min"]').val());
         var lon_seconds = parseFloat($('input[id="dms_lon_sec"]').val());

         var valid = check_dms_lon(lon_idegrees, lon_iminutes, lon_seconds);

         if (valid===true){

             lon_idegrees = Math.abs(lon_idegrees);

             $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);

             // ddm tab
             var lon_dminutes = lon_iminutes + lon_seconds / 60;
             $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="ddm_lon_min"]').val(lon_dminutes);

             // decimal degree tab
             var ddlon = lon_idegrees + lon_dminutes / 60;
             $('input[id="id_ddlon"]').val(ddlon * -1);

             refresh_map();
         }
     });






     $('input:radio[name="latlon_flag"]').on('click change', function(e) {
         var spatial_flag = $('input:radio:checked[name="latlon_flag"]').val();
         // if spatial flag is 0, clear out all of the spatial information and delete our markers

         if (spatial_flag === '2'){
             $('#derived_comment').show();

         } else {
             $('#derived_comment').hide();
         }

         if (spatial_flag === '0'){

             $('input[id="id_ddlat"]').val('');
             $('input[id="ddm_lat_deg"]').val('');
             $('input[id="ddm_lat_min"]').val('');

             $('input[id="dms_lat_deg"]').val('');
             $('input[id="dms_lat_min"]').val('');
             $('input[id="dms_lat_sec"]').val('');


             $('input[id="id_ddlon"]').val('');
             $('input[id="ddm_lon_deg"]').val('');
             $('input[id="ddm_lon_min"]').val('');

             $('input[id="dms_lon_deg"]').val('');
             $('input[id="dms_lon_min"]').val('');
             $('input[id="dms_lon_sec"]').val('');


             if (my_markers.length && typeof my_markers[0] !== 'undefined'){
                 my_map.removeLayer(my_markers[0]);
                 delete my_markers[0];
             }

//             if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
//                 popup_map.removeLayer(popup_markers[0]);
//                 delete popup_markers[0];
//             }
//

             refresh_map();

         }

     });

 });



// $(function () {
//     $('[data-toggle="popover"]').popover()
// });


</script>


{% endblock %}
