{% extends "base.html" %}


{% load staticfiles %}

{% block extrahead  %}

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/reductio/0.6.3/reductio.js"></script>  -->

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

<script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />

<!-- <script src="{% static 'leaflet-bubble.js' %}"></script> -->

<style type="text/css" media="screen">
 #filter-buttons a {
     margin-bottom: 3px;
 }
 .dc-chart g.row text {fill: black;}
</style>

{% endblock %}


{% block content %}

<div class="row" >
    <div class="col-md-12" >
        <div class="panel panel-default">
            <div class="panel-body">
                <h3>this will be a leaflet map</h3>
            </div>
        </div>
    </div>
</div>



<div class="row" >
    <div class="col-md-4" >
        <div id="catch-species-chart">
            <strong>Catch By Species</strong>
            <a class="reset" href="javascript:catSpeciesChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        </div>
    </div>

    <div class="col-md-4" >
        <div id="catch-season-chart">
            <strong>Catch By Season</strong>
            <a class="reset" href="javascript:catSeasonChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        </div>
    </div>
    <div class="col-md-4" >
        <div id="catch-space-chart">
            <strong>Catch By Space</strong>
            <a class="reset" href="javascript:catSpaceChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        </div>
    </div>
</div>

<div class="row" >
    <div class="col-md-4" >
        <div id="catch-daytype-chart">
            <strong>Catch By Day Type</strong>
            <a class="reset" href="javascript:catDaytypeChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        </div>
    </div>

    <div class="col-md-4" >
        <div id="catch-period-chart">
            <strong>Catch By Period Type</strong>
            <a class="reset" href="javascript:catPeriodChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        </div>
    </div>
    <div class="col-md-4" >
        <div id="catch-mode-chart">
            <strong>Catch By Fishing Mode</strong>
            <a class="reset" href="javascript:catModeChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        </div>
    </div>
</div>


{% endblock content %}


{% block javascript %}

<script type="text/javascript">

// var catSeasonChart = dc.barChart('#catch-season-chart');
 // var catSpaceChart = dc.barChart('#catch-space-chart');

 var catSpeciesChart = dc.pieChart('#catch-species-chart');
 var catSeasonChart = dc.rowChart('#catch-season-chart');
 var catSpaceChart = dc.rowChart('#catch-space-chart');


 var catModeChart = dc.pieChart('#catch-mode-chart');
 var catPeriodChart = dc.pieChart('#catch-period-chart');
 var catDaytypeChart = dc.pieChart('#catch-daytype-chart');

    d3.json("{% url 'catch_estimates' creel.slug %}", function (error, data) {

        data = data.results

        var mydateformat = d3.time.format('%B %d, %Y');
        var isodateformat = d3.time.format.iso;

        data.forEach(function(d){
            d.mode = d.mode;
            d.season = d.season;
            d.dtp = d.dtp;
            d.period = d.period;
            d.species = d.species;
            d.area = d.area;
            d.date = isodateformat.parse(d.date);
            d.sek = d.sek;
            d.catne = d.catne;
        });

        var estimates = crossfilter(data);

        var all = estimates.groupAll();
        var all_catne = all.reduceSum(function(d){return d.catne;});
        //var all_catae = all.reduceSum(function(d){return d.catae;});

        //create a dimension for each strata
        var modeDim = estimates.dimension(function(d) { return d.mode; });
        var ssnDim = estimates.dimension(function(d) { return d.season; });
        var daytypeDim = estimates.dimension(function(d) { return d.dtp; });
        var periodDim = estimates.dimension(function(d) { return d.period; });
        var areaDim = estimates.dimension(function(d) { return d.area; });
        var speciesDim = estimates.dimension(function(d) { return d.species; });

        // create goups from each of our dimensions
        var modeGroup = modeDim.group();
        var ssnGroup = ssnDim.group();
        var daytypeGroup = daytypeDim.group();
        var periodGroup = periodDim.group();
        var areaGroup = areaDim.group();
        var speciesGroup = speciesDim.group();

        // reducer functions for each group:
        // sum for now, but could be more complicated later

        var modeGroupcatne = modeDim.group().reduceSum(function(d) {return d.catne;});
        var ssnGroupcatne = ssnDim.group().reduceSum(function(d) {return d.catne;});
        var daytypeGroupcatne = daytypeDim.group().reduceSum(function(d) {return d.catne;});
        var periodGroupcatne = periodDim.group().reduceSum(function(d) {return d.catne;});
        var areaGroupcatne = areaDim.group().reduceSum(function(d) {return d.catne;});
        var speciesGroupcatne = speciesDim.group().reduceSum(function(d) {return d.catne;});

        // =================
        //     CHARTS

        var width = 400;
        var height = 400;
        var radius = (width * 0.7)/2;

        catSpeciesChart.width(width)
                    .height(height)
                    .radius(radius)
                    .dimension(speciesDim)
                    .group(speciesGroupcatne)
                    .render();


        catSeasonChart.width(width)
                      .height(height)
                      .dimension(ssnDim)
                      .group(ssnGroupcatne)
                      .x(d3.scale.linear().domain([0,100]))
                      .elasticX(true)
                      .render();

        catSpaceChart.width(width)
                      .height(height)
                      .dimension(areaDim)
                      .group(areaGroupcatne)
                      .x(d3.scale.linear().domain([0,100]))
                      .elasticX(true)
                      .render();

        catModeChart.width(width)
                    .height(height)
                    .radius(radius)
                    .dimension(modeDim)
                    .group(modeGroupcatne)
                    .render();

        catPeriodChart.width(width)
                    .height(height)
                    .dimension(periodDim)
                      .group(periodGroupcatne)
                      .radius(radius)
                    //.x(d3.scale.linear().domain([0,100]))
                    //.elasticX(true)
                    .render();

        catDaytypeChart.width(width)
                      .height(height)
                      .dimension(daytypeDim)
                       .group(daytypeGroupcatne)
                       .radius(radius)
                      //.x(d3.scale.linear().domain([0,100]))
                      //.elasticX(true)
                      .render();
    }
    )


</script>

{% endblock %}
